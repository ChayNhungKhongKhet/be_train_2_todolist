{% extends 'layout.html' %}

{% block content %}
    <!-- Create Button -->
    
    <div class="mb-4">
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
        <i class="fas fa-plus"></i> Add Task
      </button>
    </div>

    <!-- Task Creation Modal -->
    <div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createTaskModalLabel">Create New Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Task Creation Form -->
            <form action="{% url 'todo:create' %}" method="POST" id="form_create">
              {% csrf_token %}
              <!-- Include your form fields for task creation here -->
              <div class="mb-2">
                <label for="taskName">Task Name:</label>
                <input type="text" name="name" id="taskName" class="form-control" placeholder="Task Name" required>
              </div>
              <div class="mb-2">
                <label for="taskStatus">Status:</label>
                <select name="status" id="taskStatus" class="form-select" required>
                  <option value="1">To do</option>
                  <option value="2">In Progress</option>
                  <option value="3">Completed</option>
                </select>
              </div>
              <div class="mb-2">
                <label for="taskStartDate">Start Date:</label>
                <input type="datetime-local" name="start_date" id="taskStartDate" class="form-control" placeholder="Start Date" required>
              </div>
              <div class="mb-2">
                <label for="taskEndDate">End Date:</label>
                <input type="datetime-local" name="end_date" id="taskEndDate" class="form-control" placeholder="End Date" required>
              </div>
              <button type="submit" class="btn btn-primary">Create Task</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    {% if tasks %}
    <ul class="list-group" style="max-height: 450px; overflow-y: auto;">
      {% for task in tasks %}
      <li
        class="list-group-item d-flex justify-content-between align-items-center"
        task-id="{{ task.id }}"
      >
        <div>
          <h5 class="mb-1">{{ task.name }}</h5>
          <p class="mb-1">
            {% if task.status == 1 %}
            <span class="badge bg-primary">To do</span>
            {% elif task.status == 2 %}
            <span class="badge bg-warning">In Progress</span>
            {% elif task.status == 3 %}
            <span class="badge bg-success">Completed</span>
            {% endif %}
          </p>
          <small class="text-muted">Start Date: {{ task.start_date|date:"M j Y, g:i A" }}</small>
          <br />
          <small class="text-muted">End Date: {{ task.end_date|date:"M j Y, g:i A" }}</small>
        </div>
        <div>
          <a href="#" class="btn btn-danger btn-sm me-2 delete-task" data-task-id="{{ task.id }}">Delete</a>
          <button
            type="button"
            class="btn btn-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#editModal{{ task.id }}"
          >
            Edit
          </button>
        </div>
      </li>

      <!-- Edit Modal -->
      <div class="modal fade" id="editModal{{ task.id }}" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Edit Task</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <!-- Your edit form goes here -->
              <form action="{% url 'todo:update' task.id %}" class="form" method="POST">
                {% csrf_token %}
                <!-- Include your form fields for editing here -->
                <!-- For example: -->
                <label for="editName">Name:</label>
                <input type="text" id="editName" name="name" value="{{ task.name }}" class="form-control" required>

                <label for="editStartDate">Start Date:</label>
                <input type="datetime-local" id="editStartDate" name="start_date" value="{{ task.start_date|date:'Y-m-d\TH:i' }}" class="form-control" required>

                <label for="editEndDate">End Date:</label>
                <input type="datetime-local" id="editEndDate" name="end_date" value="{{ task.end_date|date:'Y-m-d\TH:i' }}" class="form-control" required>

                <label for="editStatus">Status:</label>
                <select id="editStatus" name="status" class="form-select" required>
                    <option value="1" {% if task.status == 1 %}selected{% endif %}>To do</option>
                    <option value="2" {% if task.status == 2 %}selected{% endif %}>In Progress</option>
                    <option value="3" {% if task.status == 3 %}selected{% endif %}>Completed</option>
                </select>

                <button type="submit" class="btn btn-primary mt-3">Save Changes</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- End Edit Modal -->

      {% endfor %}
    </ul>
    {% else %}
    <div class="text-center">
      <p>No tasks available.</p>
    </div>
    {% endif %}
{% endblock %}
{% block scripts %}
<script>
  $(document).ready(function () {

    $('#createTaskModal').on('show.bs.modal', setDefaultStartDate );

    // Handle delete button click
    $('.delete-task').click(function (e) {
      e.preventDefault();
      handleDeleteTask($(this).data('task-id'));
    });

    $('.form').on('submit', function(event) {
      event.preventDefault();
      handleEditTask($(this));
    });
    $('#form_create').on('submit', function(event) {
      event.preventDefault();
      handleCreateTask($(this));
    });
  });
  function setDefaultStartDate() {
      // Get the current date and time
      var now = new Date();

      // Get the time zone offset in minutes
      var timeZoneOffset = now.getTimezoneOffset();

      // Calculate the adjusted date and time
      var adjustedDate = new Date(now.getTime() - timeZoneOffset * 60000);

      // Format the adjusted date and time to match the input format
      var formattedDate = adjustedDate.toISOString().slice(0, 16);

      // Set the default value for start_date to the adjusted date and time
      $('#taskStartDate').val(formattedDate);
  }

  function handleCreateTask(form) {
    $.ajax({
      url: form.attr('action'),
      type: form.attr('method'),
      data: form.serialize(),
      success: function(data) {
        handleCreateTaskSuccess(data);
        for (const key in data) {
          if (data.hasOwnProperty.call(data, key)) {
            const element = data[key];
            console.log(element);
          }
        }
      },
      error: function(data) {
        let errors = data.responseJSON.errors;
        let result = ''; // Initialize result as an empty string

        for (const key in errors) {
            result = result.concat(`${errors[key]}\n`);
        }

        alert(result);
      }
    });
  }

  function handleCreateTaskSuccess(data) {
    alert('Created task successfully');
    createTaskItem(data.data);
    clearForm();
  }

  function clearForm() {
      // Use jQuery to select and clear the form input values
      $('#taskName').val('');
      $('#taskStatus').val('1'); // Set the default status value (To do)
      setDefaultStartDate();
      $('#taskEndDate').val('');
    }

    function createTaskItem(data) {
      // Get the task list container
      var taskList = $('ul.list-group');

      // Create a new <li> element for the task
      var newTaskItem = $('<li></li>').addClass('list-group-item d-flex justify-content-between align-items-center')
        .attr('task-id', data.id);

      // Append the task details to the <li> element
      newTaskItem.append('<div><h5 class="mb-1">' + data.name + '</h5><p class="mb-1"><span class="badge bg-' + getStatusBadgeColor(data.status) + '">' + getStatusLabel(data.status) + '</span></p><small class="text-muted">Start Date: ' + formatDateTime(data.start_date) + '</small><br /><small class="text-muted">End Date: ' + formatDateTime(data.end_date) + '</small></div><div><a href="#" class="btn btn-danger btn-sm me-2 delete-task" data-task-id="' + data.id + '">Delete</a><button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal' + data.id + '">Edit</button></div>');

      // Append the new <li> element to the task list
      taskList.append(newTaskItem);

      // Optionally, you can also handle the modal creation and other actions related to the new task here
    }

    
  function handleDeleteTask(taskId) {
    // Show confirmation dialog
    if (confirm('Are you sure you want to delete this task?')) {
      // If user confirms, send Ajax request to delete the task
      $.ajax({
        type: 'POST',
        url: '{% url "todo:delete" 0 %}'.replace('0', taskId), 
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (data) {
          handleDeleteTaskSuccess(taskId);
        },
        error: function (data) {
          let errors = data.responseJSON.errors;
          let result = ''; // Initialize result as an empty string

          for (const key in errors) {
              result = result.concat(`${errors[key]}\n`);
          }
          alert(result);
        },
      });
    }
  }

  function handleDeleteTaskSuccess(taskId) {
    // Handle success, e.g., remove the task from the UI
      // Remove the deleted task from the list
      $('li[task-id="' + taskId + '"]').remove();
      $('#editModal'+taskId).remove();
  }

  function handleEditTask(form) {
    var taskId = form.attr('action').split('/').pop();
    $.ajax({
      url: form.attr('action'),
      type: form.attr('method'),
      data: form.serialize(),
      success: function(data) {
        handleEditTaskSuccess(taskId, data);
      },
      error: function(data) {
        let errors = data.responseJSON.errors;
        let result = ''; // Initialize result as an empty string

        for (const key in errors) {
            result = result.concat(`${errors[key]}\n`);
        }
        alert(result);
      }
    });
  }

  function handleEditTaskSuccess(taskId, data) {
    alert('Updated task successfully');
    $('#editModal' + taskId).modal('hide');
    updateTask(taskId, data.data);
  }

  function getStatusBadgeColor(data) {
    var bg;
    if (data.status == 1) {
      bg = 'primary'
    } else if(data.status == 2) {
      bg = 'warning'
    }else {
      bg = 'success'
    }
    return bg;
  }

  function updateTask(taskId, data) {
    // console.log(data)
    var taskItem = $('li[task-id="' + taskId + '"]');
    taskItem.find('h5.mb-1').text(data.name);
    

    taskItem.find('.mb-1 span').removeClass().addClass('badge bg-' + getStatusBadgeColor(data)).text(getStatusLabel(data.status));
    taskItem.find('small.text-muted').eq(0).text('Start Date: ' + formatDateTime(data.start_date));
    taskItem.find('small.text-muted').eq(1).text('End Date: ' + formatDateTime(data.end_date));
  }

  function formatDateTime(dateTimeString) {
    var options = {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        hour12: true,
    };

    var formattedDate = new Date(dateTimeString).toLocaleDateString('en-US', options);
    return formattedDate.replace(',', ''); // Remove the comma after the day
  }
  
  function getStatusLabel(status) {
    let result;
    if (status == 1) {
      result = 'To do'
    }
    else if (status == 2) {
      result = 'In Progress'
    }
    else {
      result = 'Completed'
    }
    return result;
  }
</script>
{% endblock %}
